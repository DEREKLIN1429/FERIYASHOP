<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FERIYA SHOP INOUT</title>
    <style>
        :root {
            --primary-color: #007bff;
            --bg-color: #f4f7f6;
            --card-bg: #ffffff;
            --danger-color: #dc3545;
            --drive-color: #198754; 
            --frame-color: #00e600; 
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg-color); 
            margin: 0; padding: 0;
            display: flex; justify-content: center; min-height: 100vh;
        }

        #status-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center;
        }
        .status-box {
            background: white; padding: 25px; border-radius: 12px; width: 80%; max-width: 280px;
            text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        .status-icon { font-size: 40px; margin-bottom: 15px; display: block; }
        .spinner {
            border: 4px solid #f3f3f3; border-top: 4px solid var(--primary-color);
            border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite;
            margin: 0 auto 15px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #status-close-btn {
            background: var(--primary-color); color: white; border: none; padding: 8px 20px;
            border-radius: 5px; margin-top: 15px; cursor: pointer; display: none; font-size: 16px;
        }

        #app-screen { width: 100%; max-width: 500px; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        
        .author-header {
            text-align: center; font-size: 0.75rem; color: #999; padding-bottom: 10px;
            letter-spacing: 1px; font-weight: 500;
        }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .header-btn { 
            font-size: 26px; cursor: pointer; color: #555; padding: 8px; 
            border-radius: 50%; transition: background 0.2s, color 0.2s;
            width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
        }
        .header-btn:active { background: #e9ecef; }
        
        .header-title { text-align: center; flex-grow: 1; }
        .header-title h2 { margin: 0; color: #333; font-size: 1.5rem; line-height: 1.4; font-weight: 800; }
        .header-title span { font-size: 0.85em; color: #666; font-weight: normal; }

        .card { background: var(--card-bg); padding: 20px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 15px; }
        .section-title { font-weight: bold; color: #555; margin-bottom: 10px; display: block; font-size: 1rem; }

        .photo-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .btn-half { flex: 1; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; color: white; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-cam { background-color: #ffc107; color: #333; }
        .btn-gallery { background-color: #fd7e14; }

        /* --- ç…§ç‰‡å®¹å™¨æ¨£å¼ --- */
        .preview-box { 
            width: 100%; 
            background: #f0fff0; 
            border: 2px solid var(--frame-color);
            border-radius: 8px; 
            display: flex; align-items: center; justify-content: center; 
            overflow: hidden;
            position: relative;
            box-sizing: border-box;
            transition: aspect-ratio 0.3s ease;
            box-shadow: 0 0 5px rgba(0, 230, 0, 0.1);
            cursor: pointer;
        }
        .preview-box:active { opacity: 0.8; }

        /* ä¸»åœ– (å¤§) */
        #main-preview-container {
            margin-bottom: 10px;
        }

        /* å‰¯åœ– (4å¼µ Grid) */
        #sub-photos-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2æ¬„ */
            gap: 10px;
        }

        .preview-box::after {
            content: ""; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            border: 4px solid transparent;
            background: 
                linear-gradient(to right, var(--frame-color) 4px, transparent 4px) 0 0,
                linear-gradient(to bottom, var(--frame-color) 4px, transparent 4px) 0 0,
                linear-gradient(to left, var(--frame-color) 4px, transparent 4px) 100% 0,
                linear-gradient(to bottom, var(--frame-color) 4px, transparent 4px) 100% 0,
                linear-gradient(to right, var(--frame-color) 4px, transparent 4px) 0 100%,
                linear-gradient(to top, var(--frame-color) 4px, transparent 4px) 0 100%,
                linear-gradient(to left, var(--frame-color) 4px, transparent 4px) 100% 100%,
                linear-gradient(to top, var(--frame-color) 4px, transparent 4px) 100% 100%;
            background-repeat: no-repeat; background-size: 20px 20px; pointer-events: none; margin: 5px;
        }
        
        .ratio-4-3 { aspect-ratio: 4/3; }
        .ratio-16-9 { aspect-ratio: 16/9; }
        .ratio-9-16 { aspect-ratio: 9/16; }
        .ratio-1-1 { aspect-ratio: 1/1; }
        .ratio-full { aspect-ratio: 9/16; }
        
        .ratio-tag {
            position: absolute; top: 5px; left: 5px;
            background: var(--frame-color); color: #000; font-weight: bold;
            padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; pointer-events: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .img-label {
            position: absolute; bottom: 5px; right: 5px;
            background: rgba(0,0,0,0.5); color: #fff;
            padding: 2px 6px; border-radius: 4px; font-size: 0.7rem; pointer-events: none;
        }

        .preview-img-display { width: 100%; height: 100%; object-fit: contain; display: none; z-index: 1; }
        .placeholder { color: #555; text-align: center; font-size: 0.85em; z-index: 0; font-weight: 500; line-height: 1.4;}

        textarea { 
            width: 100%; height: 220px; padding: 12px; border: 2px solid #eee; 
            border-radius: 8px; font-size: 16px; box-sizing: border-box; resize: none; font-family: inherit;
            transition: border 0.3s;
        }
        textarea:focus { border-color: var(--primary-color); outline: none; }
        
        /* --- èªéŸ³é–ƒçˆå‹•ç•« --- */
        @keyframes flash-red {
            0% { border-color: #eee; box-shadow: none; background-color: white; }
            50% { border-color: red; box-shadow: 0 0 15px rgba(255,0,0,0.6); background-color: #fff0f0; }
            100% { border-color: #eee; box-shadow: none; background-color: white; }
        }
        
        @keyframes flash-purple {
            0% { border-color: #eee; box-shadow: none; background-color: white; }
            50% { border-color: #a020f0; box-shadow: 0 0 10px rgba(160,32,240,0.4); background-color: #fcf0ff; }
            100% { border-color: #eee; box-shadow: none; background-color: white; }
        }

        @keyframes flash-green {
            0% { border-color: #eee; box-shadow: none; }
            50% { border-color: #28a745; box-shadow: 0 0 8px rgba(40,167,69,0.3); }
            100% { border-color: #eee; box-shadow: none; }
        }

        .anim-red { animation: flash-red 0.5s infinite; }
        .anim-purple { animation: flash-purple 1s infinite; }
        .anim-green { animation: flash-green 2s infinite; }

        /* --- èªéŸ³æŒ‰éˆ•å€å¡Š (å·²ç§»é™¤è¤‡è£½æŒ‰éˆ•) --- */
        .voice-copy-controls { 
            margin-top: 10px; 
            display: flex;
            flex-direction: column;
            gap: 10px;
        } 
        
        .lang-timer-container {
            display: flex;
            justify-content: space-between; 
            align-items: center;
        }

        .quick-lang-container {
            display: flex; 
            align-items: center;
        }
        .lang-icon { font-size: 1.2em; margin-right: 5px; }
        .small-select {
            padding: 4px 8px; border: 1px solid #ccc; border-radius: 15px; 
            font-size: 0.8rem; background-color: #fff; color: #555; outline: none;
        }
        
        .voice-timer {
            text-align: right; 
            font-size: 0.9em; 
            color: #555; 
            font-weight: bold;
        }

        .voice-btn-wrapper {
            width: 100%; 
            height: 60px; /* è®Šå¯¬ï¼Œé«˜åº¦è¨­ç‚ºå›ºå®š */
        }

        .btn-voice { 
            width: 100%; height: 100%; padding: 0; border: none; border-radius: 12px;
            background-color: #17a2b8; color: white; font-weight: bold; cursor: pointer;
            display: flex; justify-content: center; align-items: center; gap: 10px;
            font-size: 16px; 
            flex-direction: row; /* æ”¹ç‚ºæ°´å¹³æ’åˆ— */
        }

        .btn-voice.recording { background-color: var(--danger-color); animation: pulse 1s infinite; }
        
        /* --- åº•éƒ¨æŒ‰éˆ•ç¾¤çµ„ --- */
        .footer-btns-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px;
            margin-top: 20px;
            padding-bottom: 30px;
        }
        
        .btn-main { 
            width: 100%; 
            padding: 15px; 
            border: none; 
            border-radius: 15px; 
            font-size: 18px; 
            font-weight: bold; 
            cursor: pointer; 
            color: white; 
            display: flex;
            align-items: center;
            justify-content: center;
            aspect-ratio: 1/1; 
            line-height: 1.2;
            flex-direction: column; 
            text-align: center;
        }
        
        .btn-drive.btn-full-width {
            grid-column: 1 / -1; 
            aspect-ratio: 4 / 1; 
            flex-direction: row; 
            gap: 15px;
            font-size: 18px;
            padding: 15px;
        }
        
        .btn-save { background-color: var(--primary-color); }
        .btn-view { background-color: #6c757d; }
        .btn-drive { background-color: var(--drive-color); }

        /* --- è¨­å®šå½ˆçª— --- */
        #settings-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 400px; padding: 25px; 
            border-radius: 15px; max-height: 85vh; overflow-y: auto;
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
        .modal-group { margin-bottom: 15px; }
        .modal-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color: #333; }
        .modal-input { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; font-size: 0.95rem;}
        select.modal-input { background: white; }
        .hint-text { font-size: 0.8rem; color: #888; margin-top: 3px; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <div id="status-modal">
        <div class="status-box">
            <div id="status-spinner" class="spinner"></div>
            <div id="status-icon" class="status-icon" style="display:none;"></div>
            <h3 id="status-text" style="color:#333; margin:0;">Uploading...</h3>
            <p id="status-subtext" style="color:#666; font-size:0.9em; margin-top:5px;">(è³‡æ–™ä¸Šå‚³ä¸­...)</p>
            <button id="status-close-btn" onclick="closeStatusModal()">OK</button>
        </div>
    </div>

    <div id="app-screen">
        <div class="author-header">Author: DERER LIN</div>

        <div class="header">
            <div class="header-btn" onclick="openSettings()" title="Settings (è¨­å®š)">âš™ï¸</div>
            <div class="header-title">
                <h2>FERIYA SHOP INOUT</h2>
            </div>
            <div class="header-btn" onclick="openSettings()" title="Settings (è¨­å®š)">âš™ï¸</div>
        </div>

        <div class="card">
            <span class="section-title">1. Photos (åœ–ç‰‡ç´€éŒ„ - Max 5)</span>
            <div class="photo-controls">
                <button class="btn-half btn-cam" onclick="triggerCam(null)">ğŸ“· Camera (æ‹ç…§)</button>
                <button class="btn-half btn-gallery" onclick="triggerGallery(null)">ğŸ–¼ï¸ Gallery (ç›¸ç°¿)</button>
            </div>
            
            <div id="main-preview-container" class="preview-box ratio-4-3" onclick="triggerCam(0)" title="Click to change Main Photo">
                <div class="ratio-tag" id="ratio-display-tag">Ratio: 4:3</div>
                <div class="img-label">Main</div>
                <span class="placeholder" id="ph-0">Main Photo<br>(ä¸»åœ–)</span>
                <img id="preview-img-0" class="preview-img-display">
            </div>

            <div id="sub-photos-grid">
                <div class="preview-box ratio-4-3 sub-box" onclick="triggerCam(1)">
                    <div class="img-label">#2</div>
                    <span class="placeholder" id="ph-1">Photo 2</span>
                    <img id="preview-img-1" class="preview-img-display">
                </div>
                <div class="preview-box ratio-4-3 sub-box" onclick="triggerCam(2)">
                    <div class="img-label">#3</div>
                    <span class="placeholder" id="ph-2">Photo 3</span>
                    <img id="preview-img-2" class="preview-img-display">
                </div>
                <div class="preview-box ratio-4-3 sub-box" onclick="triggerCam(3)">
                    <div class="img-label">#4</div>
                    <span class="placeholder" id="ph-3">Photo 4</span>
                    <img id="preview-img-3" class="preview-img-display">
                </div>
                <div class="preview-box ratio-4-3 sub-box" onclick="triggerCam(4)">
                    <div class="img-label">#5</div>
                    <span class="placeholder" id="ph-4">Photo 5</span>
                    <img id="preview-img-4" class="preview-img-display">
                </div>
            </div>
            
            <input type="file" id="input-cam" accept="image/*" capture="environment" class="hidden" onchange="handleFile(this)">
            <input type="file" id="input-gallery" accept="image/*" class="hidden" onchange="handleFile(this)">
        </div>

        <div class="card" id="note-card">
            <span class="section-title">2. Note (æ–‡å­—/èªéŸ³)</span>
            <textarea id="noteInput" placeholder="After taking photos, type here or use voice... (æ‹ç…§å¾Œï¼Œåœ¨æ­¤è¼¸å…¥æˆ–ä½¿ç”¨èªéŸ³)"></textarea>
            
            <div class="voice-copy-controls">
                
                <div class="lang-timer-container">
                    <div class="quick-lang-container">
                        <span class="lang-icon">ğŸŒ</span>
                        <select id="main-lang" class="small-select" onchange="syncLanguage('main')">
                            <option value="cmn-Hant-TW">ä¸­æ–‡ (ç¹é«”)</option>
                            <option value="en-US">English</option>
                            <option value="ja-JP">æ—¥æœ¬èª</option>
                            <option value="hi-IN">Hindi (å°åœ°èª)</option>
                        </select>
                    </div>

                    <div class="voice-timer">
                        Time left: <span id="display-timeout" style="color:#d63384; font-size:1.1em;">10</span> s
                    </div>
                </div>

                <div class="voice-btn-wrapper">
                    <button type="button" class="btn-voice" id="voiceBtn" onclick="toggleVoice()">
                        ğŸ¤ Start Voice (é–‹å§‹éŒ„éŸ³)
                    </button>
                </div>
                
                </div>

        </div>

        <div class="footer-btns-grid">
            <button class="btn-main btn-save" id="saveBtn" onclick="saveToCloud()">
                ğŸ’¾<br>Save to Cloud<br>(å­˜æª”è‡³é›²ç«¯)
            </button>
            <button class="btn-main btn-view" onclick="viewExcel()">
                ğŸ“Š<br>View Excel<br>(æª¢è¦– Excel)
            </button>
            <button class="btn-main btn-drive btn-full-width" onclick="viewDriveFolder()">
                ğŸ“‚ View Photos (æª¢è¦–é›²ç«¯ç…§ç‰‡)
            </button>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Settings (è¨­å®š)</h3>
                <button onclick="closeSettings()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div class="modal-group">
                <label>1. Voice Timeout (éŒ„éŸ³ç¸½ç§’æ•¸)</label>
                <input type="number" id="set-timeout" class="modal-input" value="10">
            </div>

            <div class="modal-group">
                <label style="color:red;">2. Red Frame Warning (ç´…æ¡†é–ƒçˆè­¦ç¤ºç§’æ•¸)</label>
                <input type="number" id="set-warning" class="modal-input" value="3" placeholder="e.g. 3">
            </div>

            <div class="modal-group">
                <label>3. Language (èªéŸ³è¾¨è­˜èªè¨€)</label>
                <select id="set-lang" class="modal-input" onchange="syncLanguage('settings')">
                    <option value="cmn-Hant-TW">Traditional Chinese (ç¹é«”ä¸­æ–‡)</option>
                    <option value="en-US">English (è‹±æ–‡)</option>
                    <option value="ja-JP">Japanese (æ—¥æ–‡)</option>
                    <option value="hi-IN">Hindi (å°åœ°èª)</option>
                </select>
            </div>

            <div class="modal-group">
                <label>4. Photo Aspect Ratio (ç…§ç‰‡æ¯”ä¾‹)</label>
                <select id="set-ratio" class="modal-input">
                    <option value="4/3">4:3 (Standard)</option>
                    <option value="16/9">16:9 (Wide)</option>
                    <option value="9/16">9:16 (Vertical / ç›´å¼)</option>
                    <option value="1/1">1:1 (Square)</option>
                    <option value="FULL">FULL (Original / å…¨ç•«é¢)</option>
                </select>
                <div class="hint-text">* Applies to ALL 5 photos.</div>
            </div>

            <div style="text-align: center; color: var(--primary-color); font-size: 0.9em; margin-top: 15px;">
                <p>âœ… Cloud Paths are Locked (System Mode)</p>
            </div>

            <button class="btn-main btn-save" style="aspect-ratio: unset; flex-direction: row; padding: 15px;" onclick="saveSettings()">Save Settings (å„²å­˜è¨­å®š)</button>
        </div>
    </div>

<script>
    // ================= åˆå§‹åŒ– & FIXED PATHS =================
    
    const FIXED_SCRIPT_ID = "AKfycbzMVIqiYBPqiiSgByGX0sWEh_N0sGUAjgfC-3F8Kq3FQ9jTq-hmQR6Cts6N1nZisQ73Nw";
    const FIXED_SHEET_ID = "1Bc6rFBxtUPiE6J835Xt5Eq9PoVtceFi0FlTUbY9a7oc/edit?gid=0#gid=0"; 
    const FIXED_FOLDER_ID = "1f0F1CQlzztz551hdLVEyON4gR2KFs3m3";

    // å„²å­˜ 5 å¼µåœ–ç‰‡çš„ Arrayï¼Œåˆå§‹åŒ–ç‚º null
    let storedImages = [null, null, null, null, null];
    let currentTargetIndex = 0; // ç›®å‰æ­£åœ¨æ“ä½œå“ªä¸€å¼µåœ–ç‰‡ (0~4)

    let recognition;
    
    let isRecording = false; 
    let isManualStop = false; 
    let voiceTimer = null; 
    let countdownInterval = null; 
    let punctuationTimer = null; 
    let timeLeft = 0; 
    let snapshotText = ""; 

    window.onload = function() {
        showApp();
        loadSettingsToUI();
    };

    function showApp() {
        document.getElementById('app-screen').style.display = 'block';
        applySettings(); 
    }

    // ================= è¨­å®šåŠŸèƒ½ & èªè¨€åŒæ­¥ =================
    function openSettings() {
        loadSettingsToUI();
        document.getElementById('settings-modal').style.display = 'flex';
    }
    function closeSettings() {
        document.getElementById('settings-modal').style.display = 'none';
    }
    
    function syncLanguage(source) {
        let val;
        if (source === 'main') {
            val = document.getElementById('main-lang').value;
            document.getElementById('set-lang').value = val;
        } else {
            val = document.getElementById('set-lang').value;
            document.getElementById('main-lang').value = val;
        }
        localStorage.setItem("cfg_lang", val);
    }

    function saveSettings() {
        const timeout = document.getElementById('set-timeout').value;
        const warning = document.getElementById('set-warning').value;
        const lang = document.getElementById('set-lang').value; 
        const ratio = document.getElementById('set-ratio').value;

        localStorage.setItem("cfg_timeout", timeout);
        localStorage.setItem("cfg_warning", warning);
        localStorage.setItem("cfg_lang", lang);
        localStorage.setItem("cfg_ratio", ratio);
        
        document.getElementById('main-lang').value = lang;

        alert("Settings Saved!");
        closeSettings();
        applySettings();
    }

    function loadSettingsToUI() {
        document.getElementById('set-timeout').value = localStorage.getItem("cfg_timeout") || "10";
        document.getElementById('set-warning').value = localStorage.getItem("cfg_warning") || "3";
        const savedLang = localStorage.getItem("cfg_lang") || "cmn-Hant-TW";
        document.getElementById('set-lang').value = savedLang;
        document.getElementById('main-lang').value = savedLang;
        document.getElementById('set-ratio').value = localStorage.getItem("cfg_ratio") || "4/3";
    }

    function applySettings() {
        const timeout = localStorage.getItem("cfg_timeout") || "10";
        document.getElementById('display-timeout').innerText = timeout;
        const ratio = localStorage.getItem("cfg_ratio") || "4/3";
        
        // å¥—ç”¨æ¯”ä¾‹åˆ°æ‰€æœ‰åœ–ç‰‡å®¹å™¨ (0~4)
        const allBoxes = document.querySelectorAll('.preview-box');
        allBoxes.forEach(container => {
            container.className = "preview-box"; 
            if(container.id !== "main-preview-container") container.classList.add("sub-box");
            
            container.style.aspectRatio = "";

            if(ratio === "4/3") container.classList.add("ratio-4-3");
            else if(ratio === "16/9") container.classList.add("ratio-16-9");
            else if(ratio === "9/16") container.classList.add("ratio-9-16");
            else if(ratio === "1/1") container.classList.add("ratio-1-1");
            else if(ratio === "FULL") container.classList.add("ratio-full");
        });

        const tag = document.getElementById('ratio-display-tag');
        if(ratio === "FULL") tag.innerText = "Ratio: Full";
        else tag.innerText = "Ratio: " + ratio.replace("/", ":");
    }

    // ================= åœ–ç‰‡è™•ç† (æ”¯æ´5å¼µ) =================
    
    // index ç‚º null ä»£è¡¨æŒ‰ä¸Šæ–¹æŒ‰éˆ•ï¼Œé è¨­æ“ä½œç›®å‰é¸å®šæˆ–ç¬¬ä¸€å¼µç©ºç™½çš„
    // index ç‚ºæ•¸å­— (0-4) ä»£è¡¨ç›´æ¥é»æ“ŠæŸå€‹æ¡†æ¡†
    function triggerCam(index) {
        if (index !== null) {
            currentTargetIndex = index;
        } else {
            // è‡ªå‹•å°‹æ‰¾ç¬¬ä¸€å€‹ç©ºçš„ï¼Œå¦‚æœéƒ½æ»¿äº†å°±è¦†è“‹ç¬¬ä¸€å¼µ
            let emptyIndex = storedImages.findIndex(img => img === null);
            currentTargetIndex = (emptyIndex === -1) ? 0 : emptyIndex;
        }
        document.getElementById('input-cam').click(); 
    }

    function triggerGallery(index) {
        if (index !== null) {
            currentTargetIndex = index;
        } else {
            let emptyIndex = storedImages.findIndex(img => img === null);
            currentTargetIndex = (emptyIndex === -1) ? 0 : emptyIndex;
        }
        document.getElementById('input-gallery').click(); 
    }

    function handleFile(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = new Image();
                img.onload = function() { processImageWithCanvas(img); };
                img.src = e.target.result;
            }
            reader.readAsDataURL(file);
            // é‡ç½® input ä»¥ä¾¿é‡è¤‡é¸æ“‡åŒä¸€æª”æ¡ˆ
            input.value = '';
        }
    }

    function processImageWithCanvas(img) {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        const ratioStr = localStorage.getItem("cfg_ratio") || "4/3";
        
        let targetRatio = 4/3;
        let isFull = false;

        if(ratioStr === "FULL") isFull = true;
        else if(ratioStr === "16/9") targetRatio = 16/9;
        else if(ratioStr === "9/16") targetRatio = 9/16;
        else if(ratioStr === "1/1") targetRatio = 1;

        let srcW = img.width; let srcH = img.height;
        let drawW, drawH, startX, startY;

        if (isFull) {
            drawW = srcW; drawH = srcH; startX = 0; startY = 0;
        } else {
            let srcRatio = srcW / srcH;
            if (srcRatio > targetRatio) {
                drawH = srcH; drawW = srcH * targetRatio;
                startX = (srcW - drawW) / 2; startY = 0;
            } else {
                drawW = srcW; drawH = srcW / targetRatio;
                startX = 0; startY = (srcH - drawH) / 2;
            }
        }

        const MAX_WIDTH = 1000; 
        const scale = MAX_WIDTH / drawW;
        canvas.width = MAX_WIDTH; canvas.height = drawH * scale;

        ctx.drawImage(img, startX, startY, drawW, drawH, 0, 0, canvas.width, canvas.height);
        
        // å„²å­˜åˆ° Array å°æ‡‰ä½ç½®
        const base64 = canvas.toDataURL('image/jpeg', 0.8);
        storedImages[currentTargetIndex] = base64;
        
        // æ›´æ–° UI
        const previewImg = document.getElementById(`preview-img-${currentTargetIndex}`);
        const placeholder = document.getElementById(`ph-${currentTargetIndex}`);
        
        previewImg.src = base64;
        previewImg.style.display = 'block';
        if(placeholder) placeholder.style.display = 'none';

        // å¦‚æœæ˜¯ Full æ¨¡å¼ï¼Œèª¿æ•´è©²å®¹å™¨æ¯”ä¾‹
        if(isFull) {
             const container = previewImg.parentElement;
             container.style.aspectRatio = `${canvas.width} / ${canvas.height}`;
        }
    }

    // ================= èªéŸ³åŠŸèƒ½ (å·²èª¿æ•´) =================
    function toggleVoice() {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            alert("Browser not supported (è«‹ä½¿ç”¨ Chrome/Edge)"); return;
        }
        if (isRecording) {
            manualStopVoice(); 
        } else {
            startVoice();
        }
    }
    
    function startVoice() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.lang = document.getElementById('main-lang').value || 'cmn-Hant-TW';
        recognition.continuous = true; 
        recognition.interimResults = true; 

        isRecording = true;
        isManualStop = false; 
        document.getElementById('voiceBtn').classList.add('recording');
        document.getElementById('voiceBtn').innerHTML = "ğŸ›‘ Stop Recording (åœæ­¢éŒ„éŸ³)"; 
        
        snapshotText = document.getElementById('noteInput').value;
        if(snapshotText.length > 0 && !snapshotText.endsWith(" ")) {
            snapshotText += " ";
        }

        const timeoutSec = parseInt(localStorage.getItem("cfg_timeout") || "10");
        const warningSec = parseInt(localStorage.getItem("cfg_warning") || "3");
        const purpleSec = warningSec + 5; 
        
        timeLeft = timeoutSec;
        document.getElementById('display-timeout').innerText = timeLeft;
        
        const noteInput = document.getElementById('noteInput');
        noteInput.classList.remove('anim-red', 'anim-purple', 'anim-green');
        noteInput.classList.add('anim-green'); 

        if(countdownInterval) clearInterval(countdownInterval);

        countdownInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('display-timeout').innerText = timeLeft;

            noteInput.classList.remove('anim-red', 'anim-purple', 'anim-green');

            if(timeLeft <= warningSec) {
                noteInput.classList.add('anim-red');
            } else if (timeLeft <= purpleSec) {
                noteInput.classList.add('anim-purple');
            } else {
                noteInput.classList.add('anim-green');
            }

            if(timeLeft <= 0) {
                manualStopVoice(); 
            }
        }, 1000);

        recognition.onresult = function(event) {
            let currentSessionText = ''; 
            
            for (let i = event.resultIndex; i < event.results.length; ++i) {
                currentSessionText += event.results[i][0].transcript;
            }

            const noteArea = document.getElementById('noteInput');
            noteArea.value = snapshotText + currentSessionText;
            noteArea.scrollTop = noteArea.scrollHeight;

            if(punctuationTimer) clearTimeout(punctuationTimer);
            
            if(currentSessionText.trim().length > 0) {
                punctuationTimer = setTimeout(() => {
                    recognition.stop(); 
                }, 1000);
            }
        };

        recognition.onend = function() {
            if(punctuationTimer) clearTimeout(punctuationTimer);

            if (isRecording && !isManualStop && timeLeft > 0) {
                let currentVal = document.getElementById('noteInput').value.trim();
                if(currentVal.length > 0) {
                    const lastChar = currentVal.slice(-1);
                    const marks = ["ï¼Œ", "ã€‚", ",", "."];
                    if(!marks.includes(lastChar)) {
                        const lang = document.getElementById('main-lang').value;
                        const mark = lang.includes('en') ? ", " : "ï¼Œ";
                        currentVal += mark;
                        document.getElementById('noteInput').value = currentVal;
                    }
                }

                snapshotText = document.getElementById('noteInput').value;
                if(snapshotText.length > 0 && !snapshotText.endsWith(" ")) {
                    snapshotText += " "; 
                }
                recognition.start(); 
            } else {
                resetVoiceUI();
            }
        };
        
        try {
            recognition.start();
        } catch(e) {
            console.error("Start error", e);
        }
    }

    function manualStopVoice() {
        isRecording = false; 
        isManualStop = true; 
        if(recognition) recognition.stop();
        resetVoiceUI();
    }

    function resetVoiceUI() {
        if(countdownInterval) clearInterval(countdownInterval);
        if(punctuationTimer) clearTimeout(punctuationTimer);
        
        document.getElementById('voiceBtn').classList.remove('recording');
        document.getElementById('voiceBtn').innerHTML = "ğŸ¤ Start Voice (é–‹å§‹éŒ„éŸ³)"; 
        
        const noteInput = document.getElementById('noteInput');
        noteInput.classList.remove('anim-red', 'anim-purple', 'anim-green');
        
        const originalTime = localStorage.getItem("cfg_timeout") || "10";
        document.getElementById('display-timeout').innerText = originalTime;
    }

    // ================= ä¸Šå‚³èˆ‡æª¢è¦– (æ›´æ–°ç‚ºå¤šåœ–) =================
    function showStatus(type, title, subtitle) {
        const modal = document.getElementById('status-modal');
        const spinner = document.getElementById('status-spinner');
        const icon = document.getElementById('status-icon');
        const text = document.getElementById('status-text');
        const sub = document.getElementById('status-subtext');
        const closeBtn = document.getElementById('status-close-btn');

        modal.style.display = 'flex';
        text.innerText = title; sub.innerText = subtitle;

        if(type === 'loading') {
            spinner.style.display = 'block'; icon.style.display = 'none'; closeBtn.style.display = 'none';
        } else if(type === 'success') {
            spinner.style.display = 'none'; icon.style.display = 'block'; icon.innerText = 'âœ…'; closeBtn.style.display = 'none';
        } else if(type === 'error') {
            spinner.style.display = 'none'; icon.style.display = 'block'; icon.innerText = 'âŒ'; closeBtn.style.display = 'block';
        }
    }

    function closeStatusModal() { document.getElementById('status-modal').style.display = 'none'; }

    function saveToCloud() {
        const note = document.getElementById('noteInput').value;
        const folderId = FIXED_FOLDER_ID;
        const scriptUrl = `https://script.google.com/macros/s/${FIXED_SCRIPT_ID}/exec`;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•å…§å®¹
        const hasImage = storedImages.some(img => img !== null);
        if(!hasImage && !note) {
            alert("Empty! Please take at least one photo or write a note."); return;
        }

        const btn = document.getElementById('saveBtn');
        btn.disabled = true;
        showStatus('loading', 'Uploading...', 'è³‡æ–™ä¸Šå‚³ä¸­...');

        const data = { 
            note: note, 
            images: storedImages, // é€™è£¡å‚³é€çš„æ˜¯é™£åˆ— (Array)
            folderId: folderId
        };

        fetch(scriptUrl, {
            method: 'POST',
            body: JSON.stringify(data)
        })
        .then(r => r.json())
        .then(res => {
            showStatus('success', 'Upload Success!', 'ä¸Šå‚³æˆåŠŸï¼');
            // æ¸…ç©ºæ‰€æœ‰å…§å®¹
            document.getElementById('noteInput').value = "";
            storedImages = [null, null, null, null, null];
            
            // é‡ç½®æ‰€æœ‰åœ–ç‰‡é¡¯ç¤º
            for(let i=0; i<5; i++) {
                document.getElementById(`preview-img-${i}`).style.display = 'none';
                document.getElementById(`ph-${i}`).style.display = 'block';
            }
            applySettings();
            setTimeout(() => { closeStatusModal(); }, 2000);
        })
        .catch(e => {
            console.error(e);
            showStatus('error', 'Upload Failed', 'ä¸Šå‚³å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– GAS è¨­å®šã€‚');
        })
        .finally(() => {
            btn.disabled = false;
        });
    }

    function viewExcel() {
        const url = `https://docs.google.com/spreadsheets/d/${FIXED_SHEET_ID}/edit`;
        window.open(url, '_blank');
    }

    function viewDriveFolder() {
        const folderId = FIXED_FOLDER_ID;
        if(folderId && folderId.trim() !== "") {
            window.open("https://drive.google.com/drive/folders/" + folderId, '_blank');
        } else {
            if(confirm("Folder ID not set. Open Google Drive Root?")) {
                window.open("https://drive.google.com/drive/my-drive", '_blank');
            }
        }
    }
</script>

</body>
</html>
