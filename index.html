// ================= 設定區 =================
// 請填入你的 Google Sheet ID
const SPREADSHEET_ID = "請將你的_GOOGLE_SHEET_ID_貼在這裡"; 
const SHEET_NAME = "工作表1"; 
// ========================================

function doPost(e) {
  try {
    var data = JSON.parse(e.postData.contents);
    var ss = SpreadsheetApp.openById(SPREADSHEET_ID);
    var sheet = ss.getSheetByName(SHEET_NAME);
    
    // 取得資料夾 (若有傳送 folderId)
    var folderId = data.folderId;
    var folder;
    try {
      folder = DriveApp.getFolderById(folderId);
    } catch(err) {
      folder = DriveApp.getRootFolder(); 
    }

    // 處理圖片 (存入 Drive 並取得連結)
    var imageUrls = ["", "", "", "", ""];
    var images = data.images; 

    for (var i = 0; i < images.length; i++) {
      if (images[i] && images[i].includes("base64")) {
        var base64Data = images[i].split(",")[1];
        var decodedBlob = Utilities.base64Decode(base64Data);
        // 檔名加上時間戳記避免重複
        var fileName = "IMG_" + new Date().getTime() + "_" + (i+1) + ".jpg"; 
        var blob = Utilities.newBlob(decodedBlob, "image/jpeg", fileName);
        
        var file = folder.createFile(blob);
        file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        imageUrls[i] = file.getDownloadUrl(); 
      }
    }

    // 準備寫入 Sheet 的資料列 (依照您的新順序)
    // 順序：主圖, 圖2, 圖3, 圖4, 圖5, 顏色, 尺寸, 件數, 內容(Note)
    var rowData = [
      imageUrls[0], // A: 主圖(最新)
      imageUrls[1], // B: 圖2
      imageUrls[2], // C: 圖3
      imageUrls[3], // D: 圖4
      imageUrls[4], // E: 圖5
      data.color,   // F: 顏色
      data.size,    // G: 尺寸
      data.quantity,// H: 件數
      data.note     // I: 內容 (對應前端的 Note)
    ];

    sheet.appendRow(rowData);

    return ContentService.createTextOutput(JSON.stringify({result: "success"}));

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({result: "error", message: error.toString()}));
  }
}
